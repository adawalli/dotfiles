#!/usr/bin/env bash
set -euo pipefail

# Install JetBrains Mono Nerd Font idempotently

if command -v fc-list >/dev/null 2>&1 && fc-list | grep -qi "JetBrainsMono Nerd Font"; then
  exit 0
fi

uname_s=$(uname -s)
if [[ "$uname_s" == "Darwin" ]]; then
  if command -v brew >/dev/null 2>&1; then
    brew tap homebrew/cask-fonts || true
    brew list --cask font-jetbrains-mono-nerd-font >/dev/null 2>&1 || brew install --cask font-jetbrains-mono-nerd-font
  fi
else
  mkdir -p "$HOME/.local/share/fonts/JetBrainsMonoNerd"
  tmpdir=$(mktemp -d)
  curl -fsSL https://github.com/ryanoasis/nerd-fonts/releases/latest/download/JetBrainsMono.zip -o "$tmpdir/JetBrainsMono.zip"
  if command -v unzip >/dev/null 2>&1; then
    unzip -o "$tmpdir/JetBrainsMono.zip" -d "$HOME/.local/share/fonts/JetBrainsMonoNerd" >/dev/null
  else
    if command -v bsdtar >/dev/null 2>&1; then
      bsdtar -xf "$tmpdir/JetBrainsMono.zip" -C "$HOME/.local/share/fonts/JetBrainsMonoNerd"
    else
      echo "Missing 'unzip' or 'bsdtar'; skipping Nerd Font install." >&2
      exit 0
    fi
  fi
  command -v fc-cache >/dev/null 2>&1 && fc-cache -f "$HOME/.local/share/fonts" || true
fi

exit 0
