#!/usr/bin/env bash
set -euo pipefail

# Idempotent package install for macOS (brew) and Debian (apt).
# Respects CHEZMOI_NO_PACKAGES and CHEZMOI_PROFILE.

if [[ -n "${CHEZMOI_NO_PACKAGES:-}" ]]; then
  exit 0
fi

uname_s=$(uname -s)

if [[ "$uname_s" == "Darwin" ]]; then
  if ! command -v brew >/dev/null 2>&1; then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    if [[ -x /opt/homebrew/bin/brew ]]; then
      eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
  else
    eval "$(brew shellenv)"
  fi

  if [[ -f "{{ .chezmoi.sourceDir }}/Brewfile" ]]; then
    brew bundle --file "{{ .chezmoi.sourceDir }}/Brewfile"
  fi

elif [[ -f /etc/debian_version ]]; then
  sudo apt-get update -y

  # Load base list from apt-packages.txt if present
  mapfile -t pkgs < <(grep -vE '^\s*(#|$)' "{{ .chezmoi.sourceDir }}/apt-packages.txt" 2>/dev/null || true)
  # Fallback defaults if file missing
  if [[ ${#pkgs[@]} -eq 0 ]]; then
    pkgs=(git curl ca-certificates fish starship fzf ripgrep jq fd-find bat)
  fi

  # Optional heavier tools depending on profile
  case "${CHEZMOI_PROFILE:-default}" in
    minimal)
      ;; # keep minimal
    *)
      pkgs+=(zellij)
      ;;
  esac

  for p in "${pkgs[@]}"; do
    if ! dpkg -s "$p" >/dev/null 2>&1; then
      sudo apt-get install -y "$p" || true
    fi
  done

  # zellij may not exist in repos; fetch latest release matching arch
  if ! command -v zellij >/dev/null 2>&1; then
    arch=$(uname -m)
    case "$arch" in
      x86_64) target="x86_64-unknown-linux-gnu" ;;
      aarch64|arm64) target="aarch64-unknown-linux-gnu" ;;
      armv7l|armv7) target="armv7-unknown-linux-gnueabihf" ;;
      *) target="" ;;
    esac
    if [[ -n "$target" ]]; then
      tmpdir=$(mktemp -d)
      url="https://github.com/zellij-org/zellij/releases/latest/download/zellij-${target}.tar.gz"
      curl -fsSL "$url" -o "$tmpdir/zellij.tgz" || true
      if [[ -s "$tmpdir/zellij.tgz" ]]; then
        tar -xzf "$tmpdir/zellij.tgz" -C "$tmpdir" || true
        binpath=""
        if [[ -f "$tmpdir/zellij" ]]; then binpath="$tmpdir/zellij"; fi
        if [[ -z "$binpath" ]]; then binpath="$(find "$tmpdir" -maxdepth 2 -type f -name zellij | head -n1)"; fi
        if [[ -n "$binpath" ]]; then
          install -m 0755 "$binpath" "$HOME/.local/bin/zellij" || sudo install -m 0755 "$binpath" /usr/local/bin/zellij || true
        fi
      fi
    fi
  fi
fi

exit 0
