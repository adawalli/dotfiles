{{ template "sh_header" . }}

# Dependency fingerprints to trigger rerun when lists change
{{ $brewfile := "Brewfile" }}
{{- if gt (len (glob $brewfile)) 0 }}
# brewfile_sha256: {{ sha256sum (include $brewfile) }}
{{- end -}}
{{ $aptlist := "apt-packages.txt" }}
{{- if gt (len (glob $aptlist)) 0 }}
# aptlist_sha256: {{ sha256sum (include $aptlist) }}
{{- end }}



{{ if not (env "CHEZMOI_NO_PACKAGES") }}
{{ if eq .chezmoi.os "darwin" }}
if ! command -v brew >/dev/null 2>&1; then
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  if [[ -x /opt/homebrew/bin/brew ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  fi
else
  eval "$(brew shellenv)"
fi

if [[ -f "{{ joinPath .chezmoi.sourceDir "Brewfile" }}" ]]; then
  brew bundle --file "{{ joinPath .chezmoi.sourceDir "Brewfile" }}"
fi

{{ else if eq .chezmoi.os "linux" }}
if [[ -f /etc/debian_version ]]; then
  sudo apt-get update -y

  mapfile -t pkgs < <(grep -vE '^\s*(#|$)' "{{ joinPath .chezmoi.sourceDir "apt-packages.txt" }}" 2>/dev/null || true)
  if [[ ${#pkgs[@]} -eq 0 ]]; then
    pkgs=(git curl ca-certificates fish fzf ripgrep jq fd-find bat)
  fi

  case "{{ env "CHEZMOI_PROFILE" | default "default" }}" in
    minimal)
      ;;
    *)
      pkgs+=(zellij)
      ;;
  esac

  for p in "${pkgs[@]}"; do
    if ! dpkg -s "$p" >/dev/null 2>&1; then
      sudo apt-get install -y "$p" || true
    fi
  done

  # Cargo fallbacks for Rust-based tools if apt packages failed or are unavailable
  if command -v cargo >/dev/null 2>&1; then
    # Install ripgrep via cargo if not available via apt
    if ! command -v rg >/dev/null 2>&1; then
      echo "Installing ripgrep via cargo..."
      cargo install ripgrep || true
    fi

    # Install fd via cargo if not available via apt (fd-find package provides 'fdfind' command)
    if ! command -v fd >/dev/null 2>&1 && ! command -v fdfind >/dev/null 2>&1; then
      echo "Installing fd via cargo..."
      cargo install fd-find || true
    fi

    # Install bat via cargo if not available via apt
    if ! command -v bat >/dev/null 2>&1 && ! command -v batcat >/dev/null 2>&1; then
      echo "Installing bat via cargo..."
      cargo install bat || true
    fi

    # Install additional useful Rust tools
    if ! command -v just >/dev/null 2>&1; then
      echo "Installing just via cargo..."
      cargo install just || true
    fi

    # Install starship via cargo if not available via apt
    if ! command -v starship >/dev/null 2>&1; then
      echo "Installing starship via cargo..."
      cargo install starship --locked || true
    fi

    # Install atuin via cargo if not available via apt
    if ! command -v atuin >/dev/null 2>&1; then
      echo "Installing atuin via cargo..."
      cargo install atuin || true
    fi
  fi

  # Try official installers as fallback for starship and atuin if cargo failed
  if ! command -v starship >/dev/null 2>&1; then
    echo "Trying starship official installer..."
    curl -sS https://starship.rs/install.sh | sh -s -- --yes || true
  fi

  if ! command -v atuin >/dev/null 2>&1; then
    echo "Trying atuin official installer..."
    curl --proto '=https' --tlsv1.2 -LsSf https://setup.atuin.sh | sh || true
  fi

  if ! command -v zellij >/dev/null 2>&1; then
    {{ $target := "" }}
    {{ if eq .chezmoi.arch "amd64" }}{{ $target = "x86_64-unknown-linux-gnu" }}{{ end }}
    {{ if or (eq .chezmoi.arch "arm64") (eq .chezmoi.arch "aarch64") }}{{ $target = "aarch64-unknown-linux-gnu" }}{{ end }}
    {{ if or (eq .chezmoi.arch "armv7") (eq .chezmoi.arch "armv7l") }}{{ $target = "armv7-unknown-linux-gnueabihf" }}{{ end }}
    if [[ -n "{{ $target }}" ]]; then
      tmpdir=$(mktemp -d)
      url="https://github.com/zellij-org/zellij/releases/latest/download/zellij-{{ $target }}.tar.gz"
      curl -fsSL "$url" -o "$tmpdir/zellij.tgz" || true
      if [[ -s "$tmpdir/zellij.tgz" ]]; then
        tar -xzf "$tmpdir/zellij.tgz" -C "$tmpdir" || true
        binpath=$(find "$tmpdir" -maxdepth 2 -type f -name zellij | head -n1)
        if [[ -n "$binpath" ]]; then
          install -m 0755 "$binpath" "$HOME/.local/bin/zellij" || sudo install -m 0755 "$binpath" /usr/local/bin/zellij || true
        fi
      fi
    fi
  fi
fi
{{ end }}
{{ end }}

exit 0
